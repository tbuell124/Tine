export type NoteBoundary = {
  note: string;
  midi: number;
  low: number;
  mid: number;
  high: number;
};

export const NOTE_BOUNDARIES: NoteBoundary[] = [
  {
    note: 'E0',
    midi: 16,
    low: 20.01523126408,
    mid: 20.601722307054,
    high: 21.205398849359,
  },
  {
    note: 'F0',
    midi: 17,
    low: 21.205398849359,
    mid: 21.826764464563,
    high: 22.466337482065,
  },
  {
    note: 'F#0',
    midi: 18,
    low: 22.466337482065,
    mid: 23.124651419477,
    high: 23.802255427669,
  },
  {
    note: 'G0',
    midi: 19,
    low: 23.802255427669,
    mid: 24.499714748859,
    high: 25.217611188128,
  },
  {
    note: 'G#0',
    midi: 20,
    low: 25.217611188128,
    mid: 25.956543598747,
    high: 26.717128381724,
  },
  {
    note: 'A0',
    midi: 21,
    low: 26.717128381724,
    mid: 27.5,
    high: 28.305811507696,
  },
  {
    note: 'A#0',
    midi: 22,
    low: 28.305811507696,
    mid: 29.135235094881,
    high: 29.988962648295,
  },
  {
    note: 'B0',
    midi: 23,
    low: 29.988962648295,
    mid: 30.867706328508,
    high: 31.772199163988,
  },
  {
    note: 'C1',
    midi: 24,
    low: 31.772199163988,
    mid: 32.703195662575,
    high: 33.661472440878,
  },
  {
    note: 'C#1',
    midi: 25,
    low: 33.661472440878,
    mid: 34.647828872109,
    high: 35.663087752903,
  },
  {
    note: 'D1',
    midi: 26,
    low: 35.663087752903,
    mid: 36.708095989676,
    high: 37.783725305097,
  },
  {
    note: 'D#1',
    midi: 27,
    low: 37.783725305097,
    mid: 38.89087296526,
    high: 40.03046252816,
  },
  {
    note: 'E1',
    midi: 28,
    low: 40.03046252816,
    mid: 41.203444614109,
    high: 42.410797698718,
  },
  {
    note: 'F1',
    midi: 29,
    low: 42.410797698718,
    mid: 43.653528929125,
    high: 44.93267496413,
  },
  {
    note: 'F#1',
    midi: 30,
    low: 44.93267496413,
    mid: 46.249302838954,
    high: 47.604510855338,
  },
  {
    note: 'G1',
    midi: 31,
    low: 47.604510855338,
    mid: 48.999429497719,
    high: 50.435222376257,
  },
  {
    note: 'G#1',
    midi: 32,
    low: 50.435222376257,
    mid: 51.913087197493,
    high: 53.434256763448,
  },
  {
    note: 'A1',
    midi: 33,
    low: 53.434256763448,
    mid: 55,
    high: 56.611623015392,
  },
  {
    note: 'A#1',
    midi: 34,
    low: 56.611623015392,
    mid: 58.270470189761,
    high: 59.977925296589,
  },
  {
    note: 'B1',
    midi: 35,
    low: 59.977925296589,
    mid: 61.735412657016,
    high: 63.544398327975,
  },
  {
    note: 'C2',
    midi: 36,
    low: 63.544398327975,
    mid: 65.40639132515,
    high: 67.322944881756,
  },
  {
    note: 'C#2',
    midi: 37,
    low: 67.322944881756,
    mid: 69.295657744218,
    high: 71.326175505806,
  },
  {
    note: 'D2',
    midi: 38,
    low: 71.326175505806,
    mid: 73.416191979352,
    high: 75.567450610195,
  },
  {
    note: 'D#2',
    midi: 39,
    low: 75.567450610195,
    mid: 77.78174593052,
    high: 80.06092505632,
  },
  {
    note: 'E2',
    midi: 40,
    low: 80.06092505632,
    mid: 82.406889228217,
    high: 84.821595397437,
  },
  {
    note: 'F2',
    midi: 41,
    low: 84.821595397437,
    mid: 87.307057858251,
    high: 89.86534992826,
  },
  {
    note: 'F#2',
    midi: 42,
    low: 89.86534992826,
    mid: 92.498605677909,
    high: 95.209021710676,
  },
  {
    note: 'G2',
    midi: 43,
    low: 95.209021710676,
    mid: 97.998858995437,
    high: 100.870444752514,
  },
  {
    note: 'G#2',
    midi: 44,
    low: 100.870444752514,
    mid: 103.826174394986,
    high: 106.868513526897,
  },
  {
    note: 'A2',
    midi: 45,
    low: 106.868513526897,
    mid: 110,
    high: 113.223246030784,
  },
  {
    note: 'A#2',
    midi: 46,
    low: 113.223246030784,
    mid: 116.540940379522,
    high: 119.955850593178,
  },
  {
    note: 'B2',
    midi: 47,
    low: 119.955850593178,
    mid: 123.470825314031,
    high: 127.08879665595,
  },
  {
    note: 'C3',
    midi: 48,
    low: 127.08879665595,
    mid: 130.812782650299,
    high: 134.645889763512,
  },
  {
    note: 'C#3',
    midi: 49,
    low: 134.645889763512,
    mid: 138.591315488436,
    high: 142.652351011611,
  },
  {
    note: 'D3',
    midi: 50,
    low: 142.652351011611,
    mid: 146.832383958704,
    high: 151.13490122039,
  },
  {
    note: 'D#3',
    midi: 51,
    low: 151.13490122039,
    mid: 155.56349186104,
    high: 160.121850112641,
  },
  {
    note: 'E3',
    midi: 52,
    low: 160.121850112641,
    mid: 164.813778456435,
    high: 169.643190794874,
  },
  {
    note: 'F3',
    midi: 53,
    low: 169.643190794873,
    mid: 174.614115716502,
    high: 179.730699856521,
  },
  {
    note: 'F#3',
    midi: 54,
    low: 179.730699856521,
    mid: 184.997211355817,
    high: 190.418043421351,
  },
  {
    note: 'G3',
    midi: 55,
    low: 190.418043421351,
    mid: 195.997717990875,
    high: 201.740889505028,
  },
  {
    note: 'G#3',
    midi: 56,
    low: 201.740889505028,
    mid: 207.652348789973,
    high: 213.737027053793,
  },
  {
    note: 'A3',
    midi: 57,
    low: 213.737027053793,
    mid: 220,
    high: 226.446492061568,
  },
  {
    note: 'A#3',
    midi: 58,
    low: 226.446492061568,
    mid: 233.081880759045,
    high: 239.911701186357,
  },
  {
    note: 'B3',
    midi: 59,
    low: 239.911701186357,
    mid: 246.941650628062,
    high: 254.1775933119,
  },
  {
    note: 'C4',
    midi: 60,
    low: 254.1775933119,
    mid: 261.625565300599,
    high: 269.291779527024,
  },
  {
    note: 'C#4',
    midi: 61,
    low: 269.291779527024,
    mid: 277.182630976872,
    high: 285.304702023222,
  },
  {
    note: 'D4',
    midi: 62,
    low: 285.304702023222,
    mid: 293.664767917408,
    high: 302.26980244078,
  },
  {
    note: 'D#4',
    midi: 63,
    low: 302.26980244078,
    mid: 311.126983722081,
    high: 320.243700225281,
  },
  {
    note: 'E4',
    midi: 64,
    low: 320.243700225281,
    mid: 329.62755691287,
    high: 339.286381589747,
  },
  {
    note: 'F4',
    midi: 65,
    low: 339.286381589747,
    mid: 349.228231433004,
    high: 359.461399713042,
  },
  {
    note: 'F#4',
    midi: 66,
    low: 359.461399713042,
    mid: 369.994422711634,
    high: 380.836086842703,
  },
  {
    note: 'G4',
    midi: 67,
    low: 380.836086842703,
    mid: 391.995435981749,
    high: 403.481779010055,
  },
  {
    note: 'G#4',
    midi: 68,
    low: 403.481779010055,
    mid: 415.304697579945,
    high: 427.474054107587,
  },
  {
    note: 'A4',
    midi: 69,
    low: 427.474054107587,
    mid: 440,
    high: 452.892984123137,
  },
  {
    note: 'A#4',
    midi: 70,
    low: 452.892984123137,
    mid: 466.16376151809,
    high: 479.823402372713,
  },
  {
    note: 'B4',
    midi: 71,
    low: 479.823402372713,
    mid: 493.883301256124,
    high: 508.3551866238,
  },
  {
    note: 'C5',
    midi: 72,
    low: 508.3551866238,
    mid: 523.251130601197,
    high: 538.583559054048,
  },
  {
    note: 'C#5',
    midi: 73,
    low: 538.583559054048,
    mid: 554.365261953744,
    high: 570.609404046444,
  },
  {
    note: 'D5',
    midi: 74,
    low: 570.609404046444,
    mid: 587.329535834815,
    high: 604.539604881559,
  },
  {
    note: 'D#5',
    midi: 75,
    low: 604.539604881559,
    mid: 622.253967444162,
    high: 640.487400450563,
  },
  {
    note: 'E5',
    midi: 76,
    low: 640.487400450562,
    mid: 659.25511382574,
    high: 678.572763179494,
  },
  {
    note: 'F5',
    midi: 77,
    low: 678.572763179494,
    mid: 698.456462866008,
    high: 718.922799426084,
  },
  {
    note: 'F#5',
    midi: 78,
    low: 718.922799426084,
    mid: 739.988845423269,
    high: 761.672173685406,
  },
  {
    note: 'G5',
    midi: 79,
    low: 761.672173685406,
    mid: 783.990871963499,
    high: 806.963558020111,
  },
  {
    note: 'G#5',
    midi: 80,
    low: 806.963558020111,
    mid: 830.60939515989,
    high: 854.948108215173,
  },
  {
    note: 'A5',
    midi: 81,
    low: 854.948108215173,
    mid: 880,
    high: 905.785968246273,
  },
  {
    note: 'A#5',
    midi: 82,
    low: 905.785968246273,
    mid: 932.32752303618,
    high: 959.646804745427,
  },
  {
    note: 'B5',
    midi: 83,
    low: 959.646804745427,
    mid: 987.766602512248,
    high: 1016.7103732476,
  },
  {
    note: 'C6',
    midi: 84,
    low: 1016.7103732476,
    mid: 1046.502261202394,
    high: 1077.167118108097,
  },
  {
    note: 'C#6',
    midi: 85,
    low: 1077.167118108096,
    mid: 1108.730523907488,
    high: 1141.218808092888,
  },
  {
    note: 'D6',
    midi: 86,
    low: 1141.218808092889,
    mid: 1174.65907166963,
    high: 1209.079209763119,
  },
  {
    note: 'D#6',
    midi: 87,
    low: 1209.079209763118,
    mid: 1244.507934888324,
    high: 1280.974800901125,
  },
  {
    note: 'E6',
    midi: 88,
    low: 1280.974800901125,
    mid: 1318.51022765148,
    high: 1357.145526358988,
  },
  {
    note: 'F6',
    midi: 89,
    low: 1357.145526358988,
    mid: 1396.912925732016,
    high: 1437.845598852168,
  },
  {
    note: 'F#6',
    midi: 90,
    low: 1437.845598852168,
    mid: 1479.977690846538,
    high: 1523.344347370812,
  },
  {
    note: 'G6',
    midi: 91,
    low: 1523.344347370812,
    mid: 1567.981743926997,
    high: 1613.927116040221,
  },
  {
    note: 'G#6',
    midi: 92,
    low: 1613.927116040221,
    mid: 1661.218790319781,
    high: 1709.896216430346,
  },
  {
    note: 'A6',
    midi: 93,
    low: 1709.896216430346,
    mid: 1760,
    high: 1811.571936492546,
  },
  {
    note: 'A#6',
    midi: 94,
    low: 1811.571936492546,
    mid: 1864.65504607236,
    high: 1919.293609490854,
  },
  {
    note: 'B6',
    midi: 95,
    low: 1919.293609490853,
    mid: 1975.533205024496,
    high: 2033.4207464952,
  },
  {
    note: 'C7',
    midi: 96,
    low: 2033.4207464952,
    mid: 2093.004522404789,
    high: 2154.334236216193,
  },
  {
    note: 'C#7',
    midi: 97,
    low: 2154.334236216193,
    mid: 2217.461047814977,
    high: 2282.437616185777,
  },
  {
    note: 'D7',
    midi: 98,
    low: 2282.437616185777,
    mid: 2349.31814333926,
    high: 2418.158419526237,
  },
  {
    note: 'D#7',
    midi: 99,
    low: 2418.158419526237,
    mid: 2489.015869776647,
    high: 2561.94960180225,
  },
  {
    note: 'E7',
    midi: 100,
    low: 2561.94960180225,
    mid: 2637.02045530296,
    high: 2714.291052717977,
  },
  {
    note: 'F7',
    midi: 101,
    low: 2714.291052717976,
    mid: 2793.825851464031,
    high: 2875.691197704336,
  },
  {
    note: 'F#7',
    midi: 102,
    low: 2875.691197704336,
    mid: 2959.955381693075,
    high: 3046.688694741624,
  },
  {
    note: 'G7',
    midi: 103,
    low: 3046.688694741624,
    mid: 3135.963487853995,
    high: 3227.854232080443,
  },
  {
    note: 'G#7',
    midi: 104,
    low: 3227.854232080443,
    mid: 3322.437580639561,
    high: 3419.792432860693,
  },
  {
    note: 'A7',
    midi: 105,
    low: 3419.792432860692,
    mid: 3520,
    high: 3623.143872985092,
  },
  {
    note: 'A#7',
    midi: 106,
    low: 3623.143872985092,
    mid: 3729.310092144719,
    high: 3838.587218981707,
  },
  {
    note: 'B7',
    midi: 107,
    low: 3838.587218981706,
    mid: 3951.066410048992,
    high: 4066.8414929904,
  },
  {
    note: 'C8',
    midi: 108,
    low: 4066.841492990401,
    mid: 4186.009044809578,
    high: 4308.668472432387,
  },
  {
    note: 'C#8',
    midi: 109,
    low: 4308.668472432386,
    mid: 4434.922095629953,
    high: 4564.875232371553,
  },
  {
    note: 'D8',
    midi: 110,
    low: 4564.875232371553,
    mid: 4698.63628667852,
    high: 4836.316839052473,
  },
  {
    note: 'D#8',
    midi: 111,
    low: 4836.316839052473,
    mid: 4978.031739553295,
    high: 5123.8992036045,
  },
  {
    note: 'E8',
    midi: 112,
    low: 5123.8992036045,
    mid: 5274.04091060592,
    high: 5428.582105435953,
  },
  {
    note: 'F8',
    midi: 113,
    low: 5428.582105435951,
    mid: 5587.651702928062,
    high: 5751.382395408672,
  },
  {
    note: 'F#8',
    midi: 114,
    low: 5751.382395408671,
    mid: 5919.91076338615,
    high: 6093.377389483247,
  },
  {
    note: 'G8',
    midi: 115,
    low: 6093.377389483247,
    mid: 6271.926975707989,
    high: 6455.708464160886,
  },
  {
    note: 'G#8',
    midi: 116,
    low: 6455.708464160885,
    mid: 6644.875161279122,
    high: 6839.584865721386,
  },
  {
    note: 'A8',
    midi: 117,
    low: 6839.584865721385,
    mid: 7040,
    high: 7246.287745970184,
  },
  {
    note: 'A#8',
    midi: 118,
    low: 7246.287745970182,
    mid: 7458.620184289437,
    high: 7677.174437963413,
  },
  {
    note: 'B8',
    midi: 119,
    low: 7677.174437963416,
    mid: 7902.132820097988,
    high: 8133.682985980805,
  },
  {
    note: 'C9',
    midi: 120,
    low: 8133.682985980801,
    mid: 8372.018089619156,
    high: 8617.336944864774,
  },
  {
    note: 'C#9',
    midi: 121,
    low: 8617.336944864772,
    mid: 8869.844191259906,
    high: 9129.750464743107,
  },
  {
    note: 'D9',
    midi: 122,
    low: 9129.750464743111,
    mid: 9397.272573357044,
    high: 9672.63367810495,
  },
  {
    note: 'D#9',
    midi: 123,
    low: 9672.633678104947,
    mid: 9956.06347910659,
    high: 10247.798407209,
  },
  {
    note: 'E9',
    midi: 124,
    low: 10247.798407208997,
    mid: 10548.081821211836,
    high: 10857.164210871902,
  },
  {
    note: 'F9',
    midi: 125,
    low: 10857.164210871904,
    mid: 11175.303405856126,
    high: 11502.764790817346,
  },
  {
    note: 'F#9',
    midi: 126,
    low: 11502.764790817342,
    mid: 11839.821526772301,
    high: 12186.754778966495,
  },
  {
    note: 'G9',
    midi: 127,
    low: 12186.754778966491,
    mid: 12543.853951415975,
    high: 12911.416928321769,
  },
  {
    note: 'G#9',
    midi: 128,
    low: 12911.416928321773,
    mid: 13289.750322558246,
    high: 13679.169731442773,
  },
  {
    note: 'A9',
    midi: 129,
    low: 13679.169731442769,
    mid: 14080,
    high: 14492.575491940368,
  },
  {
    note: 'A#9',
    midi: 130,
    low: 14492.575491940364,
    mid: 14917.240368578874,
    high: 15354.348875926826,
  },
  {
    note: 'B9',
    midi: 131,
    low: 15354.348875926831,
    mid: 15804.265640195976,
    high: 16267.36597196161,
  },
  {
    note: 'C10',
    midi: 132,
    low: 16267.365971961603,
    mid: 16744.036179238312,
    high: 17234.673889729547,
  },
  {
    note: 'C#10',
    midi: 133,
    low: 17234.673889729544,
    mid: 17739.688382519813,
    high: 18259.500929486214,
  },
  {
    note: 'D10',
    midi: 134,
    low: 18259.500929486221,
    mid: 18794.545146714088,
    high: 19345.267356209901,
  },
  {
    note: 'D#10',
    midi: 135,
    low: 19345.267356209893,
    mid: 19912.126958213179,
    high: 20495.596814418001,
  },
];

let lastBoundaryIndex = 0;

export const findNoteBoundaryByFrequency = (frequency: number): NoteBoundary | null => {
  if (!Number.isFinite(frequency) || frequency <= 0) {
    return null;
  }

  const count = NOTE_BOUNDARIES.length;
  if (count === 0) {
    return null;
  }

  const first = NOTE_BOUNDARIES[0];
  if (frequency <= first.low) {
    lastBoundaryIndex = 0;
    return first;
  }

  const last = NOTE_BOUNDARIES[count - 1];
  if (frequency >= last.high) {
    lastBoundaryIndex = count - 1;
    return last;
  }

  if (lastBoundaryIndex >= 0 && lastBoundaryIndex < count) {
    const cached = NOTE_BOUNDARIES[lastBoundaryIndex];
    if (frequency >= cached.low && frequency <= cached.high) {
      return cached;
    }
  }

  let lowIndex = 0;
  let highIndex = count - 1;
  while (lowIndex <= highIndex) {
    const midIndex = Math.floor((lowIndex + highIndex) / 2);
    const boundary = NOTE_BOUNDARIES[midIndex];
    if (frequency < boundary.low) {
      highIndex = midIndex - 1;
    } else if (frequency > boundary.high) {
      lowIndex = midIndex + 1;
    } else {
      lastBoundaryIndex = midIndex;
      return boundary;
    }
  }

  return null;
};

export const frequencyToBoundaryCents = (frequency: number, boundary: NoteBoundary): number => {
  if (!Number.isFinite(frequency) || frequency <= 0) {
    return 0;
  }
  return 1200 * Math.log2(frequency / boundary.mid);
};
